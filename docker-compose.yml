version: "3.1"

services:
  frontend:
    container_name: "frontend-portfolio-${ENV_NAME}"
    image: "frontend-portfolio-${ENV_NAME}:${VERSION}"
    restart: "unless-stopped"
    build:
      context: "."
      dockerfile: "frontend/Dockerfile"
      target: "development"
    command: "npm run start"
    volumes:
      - "./frontend:/app:rw"
    env_file:
      - "./backend/env/.env.${ENV_NAME}"
    ports:
      - ${FRONTEND_PORT}
    depends_on:
      - "backend"
    networks:
      - "nginx-proxy-manager_default"

  backend:
    container_name: "backend-portfolio-${ENV_NAME}"
    image: "backend-portfolio-${ENV_NAME}:${VERSION}"
    restart: "unless-stopped"
    build:
      context: "."
      dockerfile: "backend/Dockerfile"
      target: "development"
    command: "npm run start"
    volumes:
      - "./backend/src:/app/src:rw"
    env_file:
      - "./backend/env/.env.${ENV_NAME}"
    ports:
      - ${BACKEND_PORT}
    depends_on:
      - "redis"
      - "mongo"
    networks:
      - "redis_net"
      - "mongo_net"
      - "nginx-proxy-manager_default"

  redis:
    container_name: "redis-portfolio-${ENV_NAME}"
    env_file:
      - "./env/.env.${ENV_NAME}"
    image: "redis:latest"
    restart: "unless-stopped"
    ports:
      - "${REDIS_PORT}"
    networks:
      - "redis_net"

  mongo:
    container_name: "mongodb-portfolio-${ENV_NAME}"
    env_file:
      - "./env/.env.${ENV_NAME}"
    image: "mongo:latest"
    restart: "unless-stopped"
    ports:
      - "${MONGO_PORT}"
    networks:
      - "mongo_net"

networks:
  redis_net:
    name: "redis_net_${ENV_NAME}"
    driver: "bridge"
  mongo_net:
    name: "mongo_net_${ENV_NAME}"
    driver: "bridge"
  backend_net:
    name: "backend_net_${ENV_NAME}"
    driver: "bridge"
  frontend_net:
    name: "frontend_net_${ENV_NAME}"
    driver: "bridge"
  nginx-proxy-manager_default:
    external: true
